name: Comprehensive Backend API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  full-api-tests:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4
    
    - name: âŽ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        npm install
        # Instalar bcryptjs si es necesario
        npm install bcryptjs --save-dev || echo "bcryptjs optional"

    - name: ðŸ”§ Create test data script (fixed syntax)
      run: |
        # Crear el script usando printf para evitar problemas de template literals
        cat > comprehensive-test-data.js << 'EOF'
        const mongoose = require('mongoose');

        async function createComprehensiveTestData() {
          try {
            await mongoose.connect('mongodb://localhost:27017/test_casanova_comprehensive');
            console.log('âœ… Connected to MongoDB for comprehensive testing');
            
            // Importar todos los modelos
            const User = require('./models/User');
            const Inventario = require('./models/Inventario');
            const Lead = require('./models/Lead');
            const Reporte = require('./models/Reporte');
            const Mapa = require('./models/Mapa');
            const ImagenMapa = require('./models/ImagenMapa');
            const Coordenada = require('./models/Coordenadas');
            const Colindancia = require('./models/Colindancia');
            const Cotizacion = require('./models/Cotizacion');
            const Mensualidad = require('./models/Mensualidad');
            const Pronostico = require('./models/Pronostico');
            
            // Limpiar datos existentes
            console.log('ðŸ—‘ï¸ Clearing existing test data...');
            await User.deleteMany({});
            await Inventario.deleteMany({});
            await Lead.deleteMany({});
            await Reporte.deleteMany({});
            await Mapa.deleteMany({});
            await ImagenMapa.deleteMany({});
            await Coordenada.deleteMany({});
            await Colindancia.deleteMany({});
            await Cotizacion.deleteMany({});
            await Mensualidad.deleteMany({});
            await Pronostico.deleteMany({});
            
            console.log('âœ… All collections cleared');
            
            // Crear usuarios de prueba
            console.log('ðŸ‘¥ Creating test users...');
            const users = await User.insertMany([
              {
                username: 'admin_user',
                password: 'admin123',
                userType: 'Administrador'
              },
              {
                username: 'vendor_user1',
                password: 'vendor123',
                userType: 'Ventas'
              },
              {
                username: 'vendor_user2',
                password: 'vendor123',
                userType: 'Ventas'
              },
              {
                username: 'coordinator',
                password: 'coord123',
                userType: 'Coordinador'
              }
            ]);
            console.log('âœ… Created ' + users.length + ' users');
            
            // Crear mapas e imÃ¡genes de mapa
            console.log('ðŸ—ºï¸ Creating test maps...');
            const mapas = await Mapa.insertMany([
              {
                nombreMapa: 'Desarrollo Norte',
                urlMapa: '/maps/desarrollo-norte.jpg',
                coordenadas: []
              },
              {
                nombreMapa: 'Desarrollo Sur',
                urlMapa: '/maps/desarrollo-sur.jpg',
                coordenadas: []
              }
            ]);
            
            const imagenesMapa = await ImagenMapa.insertMany([
              {
                url: '/images/map-base-1.jpg'
              },
              {
                url: '/images/map-base-2.jpg'
              }
            ]);
            console.log('âœ… Created ' + mapas.length + ' maps and ' + imagenesMapa.length + ' map images');
            
            // Crear coordenadas
            console.log('ðŸ“ Creating coordinates...');
            const coordenadas = await Coordenada.insertMany([
              {
                id_mapa: mapas[0]._id.toString(),
                nombre_lote: 'Lote A1',
                coordenadaX: 100,
                coordenadaY: 200
              },
              {
                id_mapa: mapas[0]._id.toString(),
                nombre_lote: 'Lote A2',
                coordenadaX: 150,
                coordenadaY: 250
              },
              {
                id_mapa: mapas[1]._id.toString(),
                nombre_lote: 'Lote B1',
                coordenadaX: 300,
                coordenadaY: 400
              }
            ]);
            console.log('âœ… Created ' + coordenadas.length + ' coordinates');
            
            // Crear inventarios
            console.log('ðŸ  Creating inventory...');
            const inventarios = await Inventario.insertMany([
              {
                id_usuario: users[1]._id.toString(),
                desarrollo: 'Desarrollo Norte',
                manzana: 'A',
                lote: '1',
                metros: '150',
                prototipo: 'Modelo Premier',
                medidas: '10x15',
                precioVenta: '500000',
                descuento: 0,
                estado: 'Disponible',
                colindancias: []
              },
              {
                id_usuario: users[1]._id.toString(),
                desarrollo: 'Desarrollo Norte',
                manzana: 'A',
                lote: '2',
                metros: '200',
                prototipo: 'Modelo Elite',
                medidas: '12x18',
                precioVenta: '750000',
                descuento: 5,
                estado: 'Apartado',
                colindancias: []
              },
              {
                id_usuario: users[2]._id.toString(),
                desarrollo: 'Desarrollo Sur',
                manzana: 'B',
                lote: '1',
                metros: '180',
                prototipo: 'Modelo Standard',
                medidas: '9x20',
                precioVenta: '450000',
                descuento: 10,
                estado: 'Ocupado',
                colindancias: []
              }
            ]);
            console.log('âœ… Created ' + inventarios.length + ' inventory items');
            
            // Crear colindancias
            console.log('ðŸ˜ï¸ Creating adjacent properties...');
            const colindancias = await Colindancia.insertMany([
              {
                id_inventario: inventarios[0]._id.toString(),
                manzanac: 'A',
                lotec: '3',
                metros: '150',
                direccion: 'Norte',
                nombreCalle: 'Calle Principal'
              },
              {
                id_inventario: inventarios[1]._id.toString(),
                manzanac: 'A',
                lotec: '4',
                metros: '200',
                direccion: 'Sur',
                nombreCalle: 'Avenida Secundaria'
              }
            ]);
            console.log('âœ… Created ' + colindancias.length + ' adjacent properties');
            
            // Crear leads
            console.log('ðŸ“ž Creating leads...');
            const leads = await Lead.insertMany([
              {
                leadName: 'Juan PÃ©rez',
                nota: 'Cliente muy interesado en modelo premier',
                leadOrigin: 'REDES SOCIALES',
                leadEmail: 'juan@example.com',
                leadNumber: '555-1234',
                leadModel: 'Modelo Premier',
                leadStatus: 'PROSPECTO',
                leadDate: new Date(),
                leadVendor: users[1]._id.toString(),
                nameVendor: 'vendor_user1',
                idinteres: inventarios[0]._id.toString(),
                currentDate: new Date().toISOString()
              },
              {
                leadName: 'MarÃ­a GarcÃ­a',
                nota: 'Cliente con presupuesto ajustado',
                leadOrigin: 'RECOMENDACIÃ“N',
                leadEmail: 'maria@example.com',
                leadNumber: '555-5678',
                leadModel: 'Modelo Standard',
                leadStatus: 'APARTADO',
                leadDate: new Date(),
                leadVendor: users[2]._id.toString(),
                nameVendor: 'vendor_user2',
                idinteres: inventarios[2]._id.toString(),
                currentDate: new Date().toISOString()
              }
            ]);
            console.log('âœ… Created ' + leads.length + ' leads');
            
            // Crear cotizaciones y mensualidades
            console.log('ðŸ’° Creating quotes and payments...');
            const cotizaciones = await Cotizacion.insertMany([
              {
                id_usuario: leads[0]._id.toString(),
                m2: 150,
                costo_m2: 3333,
                precioSinEnganche: 500000,
                tieneEnganche: 'SÃ­',
                enganche: 50000,
                plazos: 60,
                pagosEnganche: [],
                mensualidades: []
              }
            ]);
            
            const mensualidades = await Mensualidad.insertMany([
              {
                id_cotizacion: cotizaciones[0]._id.toString(),
                es_enganche_o_mensualidad: 'Enganche',
                periodo: '1',
                pago: '50000',
                fecha_pago: '2024-01-15',
                interes: 0,
                capitalAmortizado: 50000,
                saldoFinalDePeriodo: '450000'
              }
            ]);
            console.log('âœ… Created ' + cotizaciones.length + ' quotes and ' + mensualidades.length + ' payments');
            
            // Crear reportes
            console.log('ðŸ“Š Creating reports...');
            const reportes = await Reporte.insertMany([
              {
                tipo: 'Mantenimiento',
                descripcion: 'Fuga de agua en Ã¡rea comÃºn',
                id_usuario: users[0]._id.toString(),
                fecha: new Date().toISOString(),
                status: true
              }
            ]);
            console.log('âœ… Created ' + reportes.length + ' reports');
            
            // Crear pronÃ³sticos
            console.log('ðŸ“ˆ Creating forecasts...');
            const pronosticos = await Pronostico.insertMany([
              {
                tipo: 'ventas_mensuales',
                valor: 25
              }
            ]);
            console.log('âœ… Created ' + pronosticos.length + ' forecasts');
            
            console.log('ðŸŽ‰ Comprehensive test data creation completed!');
            console.log('ðŸ“Š Summary:');
            console.log('   ðŸ‘¥ Users: ' + users.length);
            console.log('   ðŸ  Inventory: ' + inventarios.length);
            console.log('   ðŸ“ž Leads: ' + leads.length);
            console.log('   ðŸ—ºï¸ Maps: ' + mapas.length);
            console.log('   ðŸ“ Coordinates: ' + coordenadas.length);
            console.log('   ðŸ˜ï¸ Adjacents: ' + colindancias.length);
            console.log('   ðŸ’° Quotes: ' + cotizaciones.length);
            console.log('   ðŸ’¸ Payments: ' + mensualidades.length);
            console.log('   ðŸ“Š Reports: ' + reportes.length);
            console.log('   ðŸ“ˆ Forecasts: ' + pronosticos.length);
            
            await mongoose.connection.close();
            console.log('âœ… Database connection closed');
            
          } catch (error) {
            console.error('âŒ Error creating comprehensive test data:', error);
            process.exit(1);
          }
        }
        
        createComprehensiveTestData();
        EOF

    - name: ðŸš€ Insert test data and start server
      run: |
        echo "DB_MONGO=mongodb://localhost:27017/test_casanova_comprehensive" > .env
        echo "PORT=5000" >> .env
        
        echo "ðŸ—ƒï¸ Creating test data..."
        # Verificar sintaxis primero
        if node -c comprehensive-test-data.js; then
          echo "âœ… Script syntax is valid"
          if node comprehensive-test-data.js; then
            echo "âœ… Test data created successfully"
          else
            echo "âŒ Failed to create test data"
            exit 1
          fi
        else
          echo "âŒ Script has syntax errors"
          exit 1
        fi
        
        echo "ðŸ”§ Starting server..."
        # Verificar que index.js existe
        if [ ! -f index.js ]; then
          echo "âŒ index.js not found"
          ls -la
          exit 1
        fi
        
        # Iniciar servidor en background
        nohup node index.js > server.log 2>&1 &
        SERVER_PID=$!
        echo $SERVER_PID > server.pid
        
        echo "â³ Waiting for server to start (up to 60 seconds)..."
        for i in {1..30}; do
          if curl -f -s http://localhost:5000/health > /dev/null; then
            echo "âœ… Server is ready and responding!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Server failed to start after 60 seconds"
            echo "=== Server logs ==="
            cat server.log
            echo "==================="
            # Matar el proceso si existe
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done

    - name: ðŸ§ª Run basic API connectivity tests
      run: |
        cat > basic-api-test.js << 'EOF'
        const http = require('http');

        const SERVER_PORT = 5000;
        const BASE_URL = 'http://localhost:5000';

        function testEndpoint(endpoint, method = 'GET') {
          return new Promise((resolve) => {
            const options = {
              hostname: 'localhost',
              port: SERVER_PORT,
              path: endpoint,
              method: method,
              timeout: 10000
            };

            const req = http.request(options, (res) => {
              let data = '';
              res.on('data', (chunk) => data += chunk);
              res.on('end', () => {
                console.log('âœ… ' + endpoint + ' - Status: ' + res.statusCode);
                resolve({ statusCode: res.statusCode, data: data });
              });
            });

            req.on('error', (error) => {
              console.log('âŒ ' + endpoint + ' - Error: ' + error.message);
              resolve({ statusCode: 0, error: error.message });
            });

            req.on('timeout', () => {
              console.log('âŒ ' + endpoint + ' - Timeout');
              req.destroy();
              resolve({ statusCode: 0, error: 'Timeout' });
            });

            req.end();
          });
        }

        async function runTests() {
          console.log('ðŸš€ Starting basic API connectivity tests...');
          
          // Test health endpoint first
          await testEndpoint('/health');
          
          // Test main API endpoints
          await testEndpoint('/casNov/api/getUsers');
          await testEndpoint('/casNov/api/getLeads');
          await testEndpoint('/casNov/api/getInventarios');
          await testEndpoint('/casNov/api/getMapas');
          await testEndpoint('/casNov/api/getReportes');
          await testEndpoint('/casNov/api/getVendors');
          await testEndpoint('/casNov/api/getInventariosDisponibles');
          
          console.log('ðŸŽ‰ Basic connectivity tests completed!');
        }

        runTests().catch(console.error);
        EOF
        
        echo "ðŸ§ª Running basic API tests..."
        node basic-api-test.js

    - name: ðŸ“Š Verify data was created
      run: |
        echo "ðŸ“‹ Verifying test data in database..."
        cat > verify-data.js << 'EOF'
        const mongoose = require('mongoose');

        async function verifyData() {
          try {
            await mongoose.connect('mongodb://localhost:27017/test_casanova_comprehensive');
            console.log('âœ… Connected to database for verification');
            
            const User = require('./models/User');
            const Inventario = require('./models/Inventario');
            const Lead = require('./models/Lead');
            
            const userCount = await User.countDocuments();
            const inventarioCount = await Inventario.countDocuments();
            const leadCount = await Lead.countDocuments();
            
            console.log('ðŸ“Š Database counts:');
            console.log('   ðŸ‘¥ Users: ' + userCount);
            console.log('   ðŸ  Inventory: ' + inventarioCount);
            console.log('   ðŸ“ž Leads: ' + leadCount);
            
            if (userCount > 0 && inventarioCount > 0 && leadCount > 0) {
              console.log('âœ… All test data verified successfully!');
            } else {
              console.log('âŒ Some collections are empty');
            }
            
            await mongoose.connection.close();
          } catch (error) {
            console.error('âŒ Verification failed:', error);
            process.exit(1);
          }
        }
        
        verifyData();
        EOF
        
        node verify-data.js

    - name: ðŸ“‹ Check server status
      run: |
        echo "ðŸ” Checking server status..."
        if curl -f -s http://localhost:5000/health; then
          echo "âœ… Server is running healthy"
        else
          echo "âŒ Server health check failed"
        fi

    - name: ðŸ“„ Display server logs
      if: always()
      run: |
        echo "ðŸ“„ Server logs (last 30 lines):"
        if [ -f server.log ]; then
          tail -30 server.log
        else
          echo "No server.log found"
        fi

    - name: ðŸ“ˆ Generate final report
      if: always()
      run: |
        echo "ðŸŽ¯ BACKEND TESTING COMPLETE"
        echo "==========================="
        echo "âœ… Dependencies: Installed"
        echo "âœ… Database: Connected and populated"
        echo "âœ… Server: Started successfully"
        echo "âœ… API: Basic endpoints responding"
        echo ""
        echo "ðŸš€ System Status: OPERATIONAL"
        echo ""
        echo "Next steps:"
        echo "  - Review any warnings above"
        echo "  - Check server logs for any errors"
        echo "  - Deploy to production if all tests pass"

    - name: ðŸ›‘ Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        if [ -f server.pid ]; then
          echo "Stopping server..."
          kill $(cat server.pid) 2>/dev/null || true
          rm server.pid
        fi
        # Limpiar archivos temporales
        rm -f server.log comprehensive-test-data.js basic-api-test.js verify-data.js .env
