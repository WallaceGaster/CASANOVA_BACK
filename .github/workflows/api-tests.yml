name: API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4
    
    - name: âŽ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: npm install
    
    - name: ðŸ§ª Create test script
      run: |
        cat > test-ci.js << 'EOF'
        const http = require('http');
        
        async function testEndpoint(endpoint) {
          return new Promise((resolve, reject) => {
            const req = http.request({
              hostname: 'localhost',
              port: 3001,
              path: endpoint,
              method: 'GET',
              timeout: 5000
            }, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                if (res.statusCode === 200) {
                  console.log('âœ… ' + endpoint + ' - Status: ' + res.statusCode);
                  resolve();
                } else {
                  console.log('âŒ ' + endpoint + ' - Status: ' + res.statusCode);
                  reject(new Error(`Status ${res.statusCode}`));
                }
              });
            });
            
            req.on('error', reject);
            req.on('timeout', () => {
              req.destroy();
              reject(new Error('Timeout'));
            });
            
            req.end();
          });
        }
        
        async function runTests() {
          console.log('ðŸš€ Starting API Tests in GitHub...');
          const tests = [
            '/',
            '/api/getUsers',
            '/api/getInventarios', 
            '/api/getLeads',
            '/api/getVendors'
          ];
          
          for (const test of tests) {
            await testEndpoint(test);
          }
          console.log('ðŸŽ‰ All tests passed!');
        }
        
        runTests().catch(err => {
          console.error('ðŸ’€ Test failed:', err.message);
          process.exit(1);
        });
        EOF
    
    - name: ðŸš€ Start server
      run: |
        echo "DB_MONGO=mongodb://localhost:27017/test_github" > .env
        echo "PORT=3001" >> .env
        nohup node index.js > server.log 2>&1 &
        echo $! > server.pid
        sleep 5
        echo "ðŸ“¡ Server started on port 3001"
    
    - name: ðŸ§ª Run API tests
      run: |
        echo "ðŸ” Running API tests..."
        node test-ci.js
    
    - name: ðŸ“‹ Show server logs if failed
      if: failure()
      run: |
        echo "ðŸ“œ Server logs:"
        cat server.log || echo "No logs available"
    
    - name: ðŸ›‘ Cleanup
      if: always()
      run: |
        kill $(cat server.pid) 2>/dev/null || echo "Server already stopped"
