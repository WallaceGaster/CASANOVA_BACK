name: Node.js Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Este flujo de trabajo se ejecuta automÃ¡ticamente cuando hay un push o pull request
# hacia las ramas "main" o "develop".

# Se encarga de probar, auditar y preparar el backend Node.js para despliegue.

jobs:
  test-backend:
    runs-on: ubuntu-latest

    # Primer trabajo: ejecuta pruebas y validaciones bÃ¡sicas del backend
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
    
    # Inicia un contenedor de MongoDB como servicio para que el backend
    # pueda probar su conexiÃ³n a base de datos.
    steps:
    - name: Obteniendo el codigo para el runner
      uses: actions/checkout@v4
    # Descarga el cÃ³digo del repositorio en el runner.
    
    - name: Configuracion de Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    # Configura el entorno con Node.js versiÃ³n 18 y habilita cache para npm.
    
    - name: Instalar dependencias
      run: npm install
    # Instala todas las dependencias del proyecto.
    
    - name: Verificar la estructura del proyecto
      run: |
        echo "ğŸ” Verificando estructura del proyecto..."
        [ -f "index.js" ] && echo "âœ… index.js existe" || exit 1
        [ -f "package.json" ] && echo "âœ… package.json existe" || exit 1
        [ -d "controllers" ] && echo "âœ… controllers/ existe" || exit 1
        [ -d "models" ] && echo "âœ… models/ existe" || exit 1
        [ -d "routes" ] && echo "âœ… routes/ existe" || exit 1
        echo "ğŸ‰ Estructura del proyecto confirmada!"
    # Revisa que la estructura bÃ¡sica del proyecto estÃ© completa y correcta.
    
    - name: Verificar la sintaxis de JavaScript
      run: |
        echo "ğŸ“ Verificando sintaxis JavaScript..."
        node -c index.js
        find controllers/ -name "*.js" -exec node -c {} \;
        find models/ -name "*.js" -exec node -c {} \;
        find routes/ -name "*.js" -exec node -c {} \;
        echo "âœ… Sintaxis JavaScript confirmada!"
    # Analiza la sintaxis de todos los archivos .js del backend sin ejecutarlos,
    # asegurando que no haya errores de sintaxis.
    
    - name: Prueba de la conexiÃ³n a la base de datos MongoDB
      run: |
        echo "ğŸ—„ï¸ Probando conexiÃ³n a MongoDB..."
        node -e "
        const mongoose = require('mongoose');
        mongoose.connect('mongodb://localhost:27017/test_casanova', {
          useNewUrlParser: true,
          useUnifiedTopology: true,
          serverSelectionTimeoutMS: 3000
        })
        .then(() => {
          console.log('âœ… MongoDB conectado exitosamente');
          process.exit(0);
        })
        .catch(err => {
          console.error('âŒ Error conectando a MongoDB:', err.message);
          process.exit(1);
        });
        "
# Ejecuta un script de Node.js para probar que la base de datos MongoDB
# levantada como servicio sea accesible y funcional.
    
    - name: Analisis de seguridades (Advertencias)
      run: npm audit --audit-level high || echo "âš ï¸ Vulnerabilidades encontradas, pero continuando..."
# Realiza un anÃ¡lisis de vulnerabilidades de seguridad en las dependencias,
# no detiene el flujo si encuentra algo, directamente continuara mostrando las advertencias.

  deployment-package:
    runs-on: ubuntu-latest
    needs: test-backend

    # Segundo job: se ejecuta solo si el primero (test-backend) pasÃ³ correctamente.
    # Este preparara un nuevo paquete para su despliegue.
    
    steps:
    - uses: actions/checkout@v4
    # Descarga nuevamente el cÃ³digo fuente.
    
    - name: Creando paquete de despliegue
      run: |
        echo "ğŸ“¦ Creando paquete de deployment..."
        mkdir -p deployment
        cp -r controllers models routes config *.js package.json deployment/
        echo "âœ… Paquete creado exitosamente"
    # Crea una carpeta "deployment" y copia dentro los archivos y directorios
    # esenciales para desplegar el backend (SIN INCLUIR LAS DEPENDENCIAS).
        
    - name: Contenido del paquete
      run: |
        echo "ğŸ“ Contenido del paquete:"
        find deployment -type f -name "*.js" | head -10
    # Muestra los archivos del paquete de despliegue para confirmar
    # que la estructura es la esperada.
